# Imports
import galois
from multiprocessing import Pool, Process
from pathos.multiprocessing import ProcessingPool as Pool
import numpy as np

import time

def increment(i, m, x):
    return (x ** i) * m[i]

# self.lpn_matrices = [ np.array([self.bitarr(k) for a in range(ecc_len)]) for _ in range(self.l) ]


def generateLPN(bits, k, ecc_len, l):
    t1 = time.time()
    p = Pool()
    matrices = p.map(lambda a : np.array([bits(k) for _ in range(ecc_len)]), range(l))
    
    t2 = time.time()
    print(f"Generated {len(matrices)} LPN matrices in {t2 - t1} seconds")

    return matrices


def mx_parallel(fm, fx, fL, poly):
    t1 = time.time()
    p = Pool()
    results = p.map(lambda a : pow(fx, a, poly) * fm[a], range(fL))
    t2 = time.time()
    s = galois.Poly.Int(0)
    for i in results:
        s = s + i
    s = s % poly
    print(f"Parallel m with {p.ncpus} workers took {time.time() - t1} seconds. {t2-t1} for map, {time.time() - t2} for sum")
    # p.close()
    return s


def mx_serial(fm, fx, fL, poly):
    t1 = time.time()
    s = galois.Poly.Int(0)
    for i in range(fL):
        s = (s + (pow(fx, i, poly) * fm[i])) % poly
    # s = s % poly
    print(f"Serial m with  took {time.time() - t1} seconds")
    
    return s

# def m(self, fm, fx, fL):
#     t1 = time.time()
#     # accumulator for sum
#     acc = self.gf.elm([0])
#     # accumulator for x^i
#     x = fx ** 0
#     for i in range(1,fL):
#         x = x * fx
#         acc = acc + (x * fm[i])
#     print(f"Serial m took {time.time() - t1} seconds")
#     return acc


# def m_(self, fm, fx, fL): # FIXME does NOT work at all
#     t1 = time.time()
#     # accumulator for sum
#     acc = self.gf.elm([])
#     # def plus(a): return (fx ** a) * fm[a]
#     # plus = lambda a : (fx ** a) * fm[a]
#     # margs = (fm, fx)
#     # a = range(fL)
#     # b = [fm for _ in range(fL)]
#     # c = [fx for _ in range(fL)]
#     d = zip(a,b,c)
#     with Pool() as p:
#         inc = p.starmap(increment, d)
#     print(inc)
#     acc = acc + sum(inc)
#     print(f"Parallel m took {time.time() - t1} seconds")
#     return acc



# ['Code is  110101101100001111010000111110110011010011110010011001100010111011010111001010000010110011111001011000110111101110110010111100110000110000011111100100100011011001000001111001110001111011100111010101110101010010001110100101011100011000010000000010101100011010110101101010111001000011011110110011110101010101101100101100011001011011000101101010100011110011101001000111101110010111111010011110100100101000010010100110101101000000001010011111101101100011111001000010111011100011111011101010000111110111101100111100010011100110010110011000000101110001111111000100001010110101100011000111100010110000110110111001100100110100111100001110000000101001001001000010011111110101000000000100001100010100100001010110100011011100101011111001011000000010010010001011000010010100001101011011101000001100001011011001011100111111111111011001101001111110010101100110000010110001100111011000110000010110100110101011010010100000101011101111010100000110010001101101000000000010001010111010010010100010110010011000100100111000001101100100011010110110110100101101001100010010110101000110000100010000011000001000110101100100011000100111000010111100101110110001010101000000000111011101100001100001000111010011010101000110010011111011101011111001110010',

#  'Error rate is  0.11',

#  '111110010101100110000010010001100111011000010000010110100110101011010010100000101011101111010100000110010001101101000000000010000010111010010010100010110010011000100100111000001101100100011010110110110100101101001100010010111101000110000000010100011000001100110101100110011000100111000010111100011110110001110101000000000111011101000001100001000111000011010101000110010011111011101010111001110110',
#  '']
# ['Code is  011011110111110101010000011001010101011001001000110101100100111010010000110001001110000001000010111100110011001011100100111001100101100010110101010011001010100110110011011101011011011001001110101011001010111000101101111101101001011101001000011101111001010000101000110101111010111110100011110110111101000111101101111101110011011011000010010000011001101010010011010110100111010011111101011100111010101100010001101010000001000001011101001010000011100100101111111111000101011000111111111010101010000000010110111110010110010100001100110111111111000011111011101011100010010011101110101100001111011100010111000111111001001011001100110100011000011111001010010100101011011001111110101001110101010110101000011001110001100001110110011001111010001001011010010010111011011001101110100011000100101101101010110100110110010110000000100011101011100011010010000001010010001111101111000001001011110001000110011101010101001101000101000001110000111000000111100001110001010100111100100001101001011110110111111111110001111100010001011101000110010100001010110111110011111011100011001111010011100100111111110001111101101001101110001111010100101110010001100010101001110010100001111010100011100000101011010110010010101011110100011010011001000001100111',
#  'Error rate is  0.11',
#  'Decoded 1 blocks, 0 valid.  Average 250.0 iterations, 3% bit changes',
#  '100011010010000001010010001111101111000001001011110001000110011101010101001101000101000001110000110000000111100001110001010100111100100001101001011110110111111111110001111100010001011101000110010100001010110111110011111011100011001111010011100100111111110001111101101001101110001111010100101110010001100010101001110010100001111010100011100000101011010110010010101011110100011010011001100001100111',
#  '']
